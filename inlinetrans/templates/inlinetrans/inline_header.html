{% load i18n %}
{% if is_staff %}
<script language="javascript">
(function ($) {
    $(document).ready(function () {
        inlinetrans_actions_html = '\
            <div class="inlinetrans_container">\
                <img id="changes-loading" src="{{ MEDIA_URL }}img/ajax-loader-transparent.gif"/>\
                <span class="show_inlinetrans_bar">||</span>\
                <span class="inlinetrans_actions">\
                    <span class="inlinetrans_action hightlight_trans">{% trans "See Tranlated items" %}</span>\
                    <span class="inlinetrans_action hightlight_notrans">{% trans "See not translated items" %}</span>\
                    <span class="inlinetrans_action restart_server">{% trans "Apply changes" %}</span>\
                </span>\
            </div>';
        $("body").prepend(inlinetrans_actions_html);
        
        var some_changes = false;
        var send_translation = function (){
            var msgid = $(this).attr('rel');
            var untranslated = false;
            var old_msgstr = $(this).html() ;
            var msgstr = prompt('{% trans "Give a new translation for " %} "' + msgid + '" {% trans "to" %} {{ language }}', old_msgstr);
            if (msgstr == null){
                return false;
            }
            if (msgstr == ""){
                answer = confirm("{% trans "You're sending a empty translation Â¿Are you sure? " %}");
                var msgstr = "";
            }
            else {
                answer = true;
            }
            if(answer){
                var item = $(this);
                active_loading();
                $.ajax({
                    data: "msgid=" + msgid + "&msgstr=" + msgstr,
                    url: "{% url inlinetrans.views.set_new_translation %}",
                    type: "POST",
                    async: true,
                    success: function(response){
                        item.html(msgstr || msgid);
                        some_changes = true;
                        disable_loading();
                        active_restart();
                    },
                    error: function(response){
                        alert("{% trans "Can't send translation" %}");
                        disable_loading();
                    }
                });
            }
            return false;
        }
        var active_translation = false;

        var active_translations = function () {
            if ($("span.inlinetrans_actions span.active").length && !active_translation) {
                active_translation = true;
                $("a > span.translatable").each(function(){
                    $(this).parent().click(function () {
                        return false;
                    });
                });
                $("span.translatable").click(send_translation);
            }
        }

        var active_loading = function() {
            $("img#changes-loading").show();
        }

        var disable_loading = function() {
            $("img#changes-loading").hide();
        }

        var disable_translations = function () {
            if ($("span.inlinetrans_actions span.active").length == 0 && active_translation) {
                active_translation = false;
                $("span.translatable").unbind("click", send_translation);
                $("a > span.translatable").each(function(){
                    $(this).parent().unbind('click');
                });
            }
        }

        $("span.hightlight_trans").click(function(){
            $("span.translatable").toggleClass("inlinetrans_highlight");
            $(this).toggleClass("active");
            if ($(this).hasClass("active")) {
                active_translations();
            }
            else {
                disable_translations();
            }
        });

        $("span.show_inlinetrans_bar").click(function(){
            $(this).toggleClass("active");
            if ($(this).hasClass("active")){
                $("span.inlinetrans_actions").css({ display: "inline" });
            }
            else{
                $("span.inlinetrans_actions").css({ display: "none" });
                disable_translations();
            }
        });

        $("span.hightlight_notrans").click(function(){
            $(this).toggleClass("active");
            if ($(this).hasClass("active")) {
                active_translations();
            }
            else {
                disable_translations();
            }
            $("span.untranslated").toggleClass("inlinetrans_untranslated");
        });

        active_restart = function () {
            $("span.restart_server").css({display: 'inline'});
            $("span.restart_server").click(function(){
                if (some_changes){
                    $("span.restart_server").html("{% trans "Applying Changes" %}");
                    $(this).toggleClass("active");
                    active_loading();
                    $.ajax({
                            data: "",
                            url: "{% url inlinetrans.views.do_restart %}",
                            type: "POST",
                            async: true,
                            success: function(response){
                                some_changes = false;
                                $("span.restart_server").html("{% trans "Reloading" %}");
                                setTimeout(function(){
                                   document.location = document.location;
                                   $("span.restart_server").html("{% trans "Apply Changes" %}");
                                   $("span.restart_server").toggleClass("active");
                                   disable_loading();
                                }, parseInt(response) * 1000);
                            },
                            error: function(response){
                                alert("{% trans "Can't restart server" %}");
                                disable_loading();
                            }
                    });
                }
            });
        }

    });
})(jQuery);
</script>


<style type="text/css">
div.inlinetrans_container {
    display: inline;
    height: 16px;
    border: #DDDDDD solid 1px;
    position: fixed;
    top: 0px;
    right: 0px;
    z-index : 1000;
    float: right;
    background-color: #EDEDED;
    font-family: sans-serif;
    font-size: 11px;
}

span.show_inlinetrans_bar {
    cursor: pointer;
    padding: 1px 3px 2px 3px;
}

span.inlinetrans_action {
    padding: 0 5px 0 5px;
    cursor: pointer;
}

span.inlinetrans_actions, 
span.restart_server {
    display: none;
}

div.inlinetrans_container .active{
    background-color: #bfbfbf;
}


span.inlinetrans_untranslated {
    background-color: #ffc0cb !important;

}

span.inlinetrans_highlight {
    background-color: #90ee90;
}

img#changes-loading {
    display: none;
    width: 16px;
    height: 16px;
}

</style>
{% endif %}
